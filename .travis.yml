if: tag != latest_develop # dont build for the latest_develop tagged version

dist: xenial
git:
  depth: false
language: go
go:
  - 1.11.x
services:
  - docker
addons:
  apt:
    packages:
      - postgresql-12
      - postgresql-client-12
env:
  global:
  - GO111MODULE=on
  - PGVER=12
  - PGPORT=5433
  - PGUSER=postgres
before_install:
  - sudo cp /etc/postgresql/{9.6,12}/main/pg_hba.conf
  - sudo pg_ctlcluster 12 main restart
  - echo -e "machine github.com\n  login $CI_USER_TOKEN" > ~/.netrc
  - nvm install 12
  - travis_retry make pre-ui
  - make generate
  - CI=false make ui-only
  #- go get -v github.com/mgechev/revive
before_script:
  - psql -c 'create database "stash-box-test";' -U postgres
  - psql -c 'CREATE EXTENSION pg_trgm;' -U postgres stash-box-test
script:
  # left lint off to avoid getting extra dependency
  #- make lint
  - make vet it
after_success:
  - docker pull stashapp/box-compiler:1
  - make cross-compile-docker-packr
before_deploy:
  # push the latest tag when on the develop branch
  - if [ "$TRAVIS_BRANCH" = "develop" ]; then git tag -f latest_develop; git push -f --tags; fi
  - export RELEASE_DATE=$(date +'%Y-%m-%d %H:%M:%S %Z')
  - export STASH_VERSION=$(git describe --tags --exclude latest_develop)
  # set TRAVIS_TAG explcitly to the version so that it doesn't pick up latest_develop
  - if [ "$TRAVIS_BRANCH" = "master"]; then export TRAVIS_TAG=${STASH_VERSION}; fi
deploy:
  # latest develop release
  - provider: releases
    # use the v2 release provider for proper release note setting
    edge: true
    api_key:
      secure: Yg/+6HRcr5MIwzskP2aq0AypLyCZFPrTYIw3GZQiWjgVrC6Xsix5M28rRHudTMOc4ZgxTlYUGxdTYUFrIBA1M3B02GwDOiItT3WDWml+4bER2pl2VjDzm/D5bH+5ixaOhwY9Kn51Lb7q/SIlxuHw8LVHlu/4AdGAmexccDb6LFm5BdkhRR7vWEom2D507cFeIT9LaJXBJRMRn2TsaLPZZBOm0NY4LLJ8Ncd1A87eB35nYvuIEzwlHzZbg/jiwBZvBXAPHKcuY2PmuUstuyNt6rfL6uGn8kGNTDc2UNorgjbU6Ax6CtF4L4HbLh/fFFQaY8RDXmwc4okd7cliUHD7S7Bd2N37NExcT9CuVjkME9Z63L/21y3PCy7CTYpMbACBegjlcaVF4ZdqVh+CS7OQPbCSrs9VmQuVG7EsEdM9KlCgzj0ovSw2ikfMWjgsV1fAWhZp1C467eSCwjUt6WrxXdPX5OfWgsHRJaPCOPb+PPWVqwDx5y3CSIY851Gs1+gMuBFnak6jE4wBPZY4WNgfJDjHD8TJgauFUKjqdBjVgpQeTP57VXv8q6FQpO6NtFR7oO3lt7JM9XOiDieFOlDt4rXtO+8w6eJK9H6gny6rjHO+2yH/rXY+idE9FoOXQoElBsJKpbtHJ2plhiN5as/fWdPfe7NhbxlajbGBN4bZ9Xk=
    file:
    - dist/stashdb-osx
    - dist/stashdb-win.exe
    - dist/stashdb-linux
    skip_cleanup: true
    overwrite: true
    name: "${STASH_VERSION}: Latest development build"
    release_notes: "**${RELEASE_DATE}**\n This is always the latest committed version on the develop branch. Use as your own risk!"
    prerelease: true
    on:
      repo: stashapp/stash-box
      branch: develop
  # official master release - only build when tagged
  - provider: releases
    api_key:
      secure: Yg/+6HRcr5MIwzskP2aq0AypLyCZFPrTYIw3GZQiWjgVrC6Xsix5M28rRHudTMOc4ZgxTlYUGxdTYUFrIBA1M3B02GwDOiItT3WDWml+4bER2pl2VjDzm/D5bH+5ixaOhwY9Kn51Lb7q/SIlxuHw8LVHlu/4AdGAmexccDb6LFm5BdkhRR7vWEom2D507cFeIT9LaJXBJRMRn2TsaLPZZBOm0NY4LLJ8Ncd1A87eB35nYvuIEzwlHzZbg/jiwBZvBXAPHKcuY2PmuUstuyNt6rfL6uGn8kGNTDc2UNorgjbU6Ax6CtF4L4HbLh/fFFQaY8RDXmwc4okd7cliUHD7S7Bd2N37NExcT9CuVjkME9Z63L/21y3PCy7CTYpMbACBegjlcaVF4ZdqVh+CS7OQPbCSrs9VmQuVG7EsEdM9KlCgzj0ovSw2ikfMWjgsV1fAWhZp1C467eSCwjUt6WrxXdPX5OfWgsHRJaPCOPb+PPWVqwDx5y3CSIY851Gs1+gMuBFnak6jE4wBPZY4WNgfJDjHD8TJgauFUKjqdBjVgpQeTP57VXv8q6FQpO6NtFR7oO3lt7JM9XOiDieFOlDt4rXtO+8w6eJK9H6gny6rjHO+2yH/rXY+idE9FoOXQoElBsJKpbtHJ2plhiN5as/fWdPfe7NhbxlajbGBN4bZ9Xk=
    file:
    - dist/stashdb-osx
    - dist/stashdb-win.exe
    - dist/stashdb-linux
    # make the release a draft so the maintainers can confirm before releasing
    draft: true
    skip_cleanup: true
    overwrite: true
    # don't write the body. To be done manually for now. In future we might 
    # want to generate the changelog or get it from a file
    name: ${STASH_VERSION}
    on:
      repo: stashapp/stash-box
      tags: true
      # make sure we don't release using the latest_develop tag
      condition: $TRAVIS_TAG != latest_develop
